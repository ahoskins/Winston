var winstonApp=angular.module("winstonApp",["LocalStorageModule","ui.calendar","pmkr.filterStabilize","ui.bootstrap","ngRoute","ngProgressLite","ngAnimate","ngMaterial","djds4rce.angular-socialshare"]);winstonApp.config(["$routeProvider",function(e){e.when("/browse",{templateUrl:"partials/browse.jade",resolve:{courseData:["courseDataMaker",function(e){return e.coursesDataPromise}]}}).when("/schedule",{templateUrl:"partials/schedule.jade",controller:"scheduleCtrl",resolve:{theData:["readyMadeSchedules",function(e){return e.getSchedulesPromise()}]}}).otherwise({redirectTo:"/browse"})}]),winstonApp.run(["$FB",function(e){e.init("1605906902964485")}]),winstonApp.controller("accordionCtrl",["$scope","$window","detailFactory","courseDataMaker","$timeout","$location","pmkr.filterStabilize","addedCourses","localStorageService","currentTerm",function(e,t,n,r,a,o,s,c,u,i){function d(e,t){return t.substring(0,e+1)+" "+t.substring(e+1)}function l(e,t){var n=!1;return t.forEach(function(t){t===e.toUpperCase()&&(n=!0)}),n}e.courseData=r.treeCourses,e.courseDataFlatCourses=r.flatCourses,e.courseDataFlatSubjects=r.flatSubjects,e.subjects=[],e.renderSubjects=function(t,n){"ng-binding"===n.target.className&&(e.subjects[t]=!e.subjects[t])},e.courses=[],e.renderCourses=function(t,n){"ng-binding"===n.target.className&&(e.courses[t]=!e.courses[t])},e.description={},e.credits={},e.faculty={},e.subjectTitle={},e.showId=[],e.loadMore=function(r){e.description.hasOwnProperty(r)||n.getDetails(r).success(function(t){var n=angular.fromJson(t);e.description[r]=n.courseDescription,e.credits[r]=n.units,e.faculty[r]=n.faculty,e.subjectTitle[r]=n.subjectTitle}).error(function(){t.alert("Something fucked up.")})},a(function(){e.searchText=""},500);var f;e.$watch("model.searchBox",function(t){if(p(t)){f&&a.cancel(f),f=a(function(){e.searchText=t},500);for(index in e.subjects)e.subjects[index]=0;for(index in e.courses)e.courses[index]=0}}),e.courseSearchResults=s(function(t){if(_.isString(t)){if(!l(t,e.courseDataFlatSubjects))for(var n=0;n<t.length-1;n++){var r=d(n,t);if(l(r,e.courseDataFlatSubjects)){t=r;break}}var a=new Fuse(e.courseDataFlatCourses,{keys:["courseTitle"],includeScore:!0}),o=new Fuse(e.courseDataFlatCourses,{keys:["subjectTitle"],includeScore:!0}),s=new Fuse(e.courseDataFlatCourses,{keys:["asString"],includeScore:!0}),c=new Fuse(e.courseDataFlatCourses,{keys:["number"],includeScore:!0}),u=[];return Array.prototype.push.apply(u,_.map(o.search(t),function(e){return _.extend(e,{weight:1})})),Array.prototype.push.apply(u,_.map(a.search(t),function(e){return _.extend(e,{weight:3})})),Array.prototype.push.apply(u,_.map(s.search(t),function(e){return _.extend(e,{weight:5})})),Array.prototype.push.apply(u,_.map(c.search(t),function(e){return _.extend(e,{weight:.1})})),u=_.chain(u).sortBy(function(e){return e.score*e.weight}).uniq(function(e){return e.item}).value().slice(0,100),u=_.pluck(u,"item")}}),e.added=c.courseAdded,e.addedCoursesData=c.data,e.currentTerm=i,e.$watchCollection("added",function(){u.set("addedCourses.courseAdded",e.added)}),e.$watchCollection("addedCoursesData",function(){u.set("addedCourses.data",e.addedCoursesData)}),e.addToSchedule=function(e){c.data[i.termId]||(c.data[i.termId]=[]),c.courseAdded[i.termId]||(c.courseAdded[i.termId]={}),-1===c.data[i.termId].indexOf(e)&&(c.data[i.termId].push(e),c.courseAdded[i.termId][e.asString]=1)},e.removeFromSchedule=function(e){if(c.data[i.termId]){var t=c.data[i.termId].indexOf(e);-1!==t&&(c.data.splice(t,1),c.courseAdded[e.asString]=0)}};var p=function(e){return"string"==typeof e}}]),winstonApp.controller("addLessBusyTimeModalCtrl",["$scope","$modalInstance",function(e,t){e.dismiss=function(){t.dismiss()}}]),winstonApp.controller("addedCoursesModalCtrl",["$scope","$modalInstance","addedCourses","$window","$location","ngProgressLite","currentTerm",function(e,t,n,r,a,o,s){e.added=n.data,e.currentTerm=s,e.viewSchedules=function(){a.path("/schedule"),o.start(),t.dismiss()},e.emptyAll=function(){n.data[s.termId].length=0},e.emptyCourse=function(e){var t=n.data[s.termId].indexOf(e);n.data[s.termId].splice(t,1),n.courseAdded[s.termId][e.asString]=0}}]),winstonApp.controller("addedCtrl",["$scope","$location","$interval","ngProgressLite","addedCourses","$window","currentTerm",function(e,t,n,r,a,o,s){e.added=a.data,e.currentTerm=s,e.viewSchedules=function(){t.path("/schedule"),r.start()},e.emptyAll=function(){a.data[s.termId].length=0},e.emptyCourse=function(e){var t=a.data[s.termId].indexOf(e);a.data[s.termId].splice(t,1),a.courseAdded[s.termId][e.asString]=0}}]),winstonApp.controller("headerCtrl",["$scope","$location","$modal","$window",function(e,t,n){e.open=function(){n.open({templateUrl:"addedCoursesModal.html",controller:"addedCoursesModalCtrl"})},e.back=function(){t.path("/browse")},e.showAdded=!0,e.showBackToBrowse=!1,e.$watch(function(){return t.path()},function(){"/schedule"==t.path()?(e.showAdded=!1,e.showBackToBrowse=!0):(e.showAdded=!0,e.showBackToBrowse=!1)})}]),winstonApp.controller("noAddedCoursesModalCtrl",function(){}),winstonApp.controller("noSchedulesModalCtrl",["$scope","$modalInstance",function(e,t){e.dismiss=function(){t.dismiss()}}]),winstonApp.controller("scheduleCtrl",["$scope","$window","$location","uiCalendarConfig","$timeout","readyMadeSchedules","addedBusyTime","$modal","preferencesValues","localStorageService","$document",function(e,t,n,r,a,o,s,c,u,i,d){function l(){e.editableMode=!0,e.busyTimeButtonText="Done",v(),e.events=s.data,g(),f()}function f(){$("div.fc-time-grid-container").each(function(){this.style.setProperty("background-color",T,"important"),$(this).hover(function(){this.style.setProperty("background-color",C,"important")},function(){this.style.setProperty("background-color",T,"important")})})}function p(){$("div.fc-time-grid-container").each(function(){this.style.setProperty("background-color",k,"important"),$(this).unbind("mouseenter mouseleave")})}function m(){p();var t=e.events.slice(0);s.data.length=0,Array.prototype.push.apply(s.data,t),prefs=[e.morningPref,e.marathonPref,e.nightPref],u.data.length=0,Array.prototype.push.apply(u.data,prefs),I=0,e.currentPref=prefs[0],e.currentPrefName=A[0],b(),e.busyTimeButtonText="Customize",o.getSchedulesPromise(!0).then(function(){w=o.readyMadeSchedules,null!==w?(e.scheduleIndex=0,e.scheduleLength=w.length,e.events=w[0].concat(s.data)):(e.events=s.data,e.scheduleLength=0),g()})}function h(){$(".fc-time-grid-event").each(function(){$(this).tooltip("disable")})}function g(){r.calendars.weekView.fullCalendar("removeEvents"),r.calendars.weekView.fullCalendar("addEventSource",e.events)}function y(){html2canvas(document.getElementById("full-calendar-div"),{onrendered:function(e){P=e}})}function v(){s.data.forEach(function(e){e.durationEditable=!0})}function b(){s.data.forEach(function(e){e.durationEditable=!1})}e.addedBusyTime=s.data,e.$watchCollection("addedBusyTime",function(){i.set("addedBusyTime.data",e.addedBusyTime)}),e.preferencesValues=u.data,e.$watchCollection("preferencesValues",function(){i.set("preferencesValues.data",e.preferencesValues)}),t.scrollTo(0,0);var w=o.readyMadeSchedules;e.events=[],e.scheduleIndex=0;var S=s.data.length||0;b(),null!==w?(e.scheduleLength=w.length,e.events=w[0].concat(s.data)):e.events=s.data,a(function(){g(),y(),$("div.fc-time-grid-container").each(function(){this.style.setProperty("background-color",k,"important"),$(".fc-today").removeClass("fc-today")})},0),e.uiConfig={calendar:{height:"auto",header:!1,selectable:!0,defaultView:"agendaWeek",columnFormat:"dddd",hiddenDays:[0,6],minTime:"08:00:00",maxTime:"21:00:00",allDaySlot:!1,allDayDefault:!1,eventRender:function(e,t){$(t).attr("title",e.description),$(t).tooltip({container:"body"})},select:function(t,n){e.editableMode&&(e.events.push({durationEditable:!0,title:"Busy Time",start:t,end:n,color:"#263238",id:S++}),g())},eventClick:function(t){"Busy Time"===t.title&&t.durationEditable!==!1&&(e.events.forEach(function(n){n.id===t.id&&e.events.splice(e.events.indexOf(n),1)}),g())},eventResizeStop:function(t){e.events.forEach(function(n){n.id===t.id&&(e.events[e.events.indexOf(n)]=t)})}}},d.bind("keydown",function(t){"/schedule"==n.path()&&null!==w&&(39===t.keyCode?e.displayDifferentSchedule(1):37===t.keyCode&&e.displayDifferentSchedule(0))}),e.displayDifferentSchedule=function(t){if(null!==w&&!e.editableMode){if(t){if(e.scheduleIndex==e.scheduleLength-1)return;e.scheduleIndex++}else{if(0==e.scheduleIndex)return;e.scheduleIndex--}e.events=w[e.scheduleIndex].concat(s.data),g(),y()}},e.backToBrowse=function(){n.path("/browse")},e.busyTimeButtonText="Customize",e.editableMode=!1;var T="#90CAF9",C="#64B5F6",k="#EFEFEF";e.open=function(){e.editableMode=!e.editableMode,e.editableMode?l():m()},$("#help-button").attr("data-title","Adjust the sliders and draw busy time on the schedule. When you're done, the schedules will be regenerated to meet your preferences."),$("#help-button").tooltip({item:"help-button[data-title]"}),3===u.data.length?(e.morningPref=u.data[0],e.marathonPref=u.data[1],e.nightPref=u.data[2]):(e.morningPref=null,e.marathonPref=null,e.nightPref=null);var A=["Mornings?","Marathons?","Nights?"],I=0;e.currentPref=e.morningPref,e.currentPrefName=A[0],e.$watch("currentPref",function(){switch(I){case 0:e.morningPref=e.currentPref;break;case 1:e.marathonPref=e.currentPref;break;case 2:e.nightPref=e.currentPref}prefs=[e.morningPref,e.marathonPref,e.nightPref]}),e.nextPref=function(){e.editableMode&&2>I&&(I++,e.currentPref=prefs[I],e.currentPrefName=A[I])},e.prevPref=function(){e.editableMode&&I>0&&(I--,e.currentPref=prefs[I],e.currentPrefName=A[I])},e.image=function(){e.events=w[e.scheduleIndex],g(),y(),a(function(){t.open(P.toDataURL("image/png")),e.events=w[e.scheduleIndex].concat(s.data),g(),y()},500)},e.backToBrowse=function(){h(),n.path("/browse")};var P}]),winstonApp.controller("termCtrl",["$scope","$window","currentTerm","localStorageService",function(e,t,n,r){e.availableTerms=[{name:"Fall 2014",termId:"1490"},{name:"Winter 2015",termId:"1500"},{name:"Spring 2015",termId:"1510"},{name:"Summer 2015",termId:"1520"},{name:"Fall 2015",termId:"1530"},{name:"Winter 2016",termId:"1540"}],e.currentTerm=n,e.changeTerm=function(a){e.currentTerm.name=a.name,e.currentTerm.termId=a.termId,n=e.currentTerm,r.set("currentTerm",n),t.location.reload()}}]),winstonApp.factory("addedBusyTime",["localStorageService",function(e){var t={};t.data=e.get("addedBusyTime.data")||[],t.apiFormattedData=[],t.generateApiFormattedBusyTimes=function(){t.apiFormattedData=[],t.data.forEach(function(e){"Busy Time"===e.title&&t.apiFormattedData.push(n(e))})};var n=function(e){var t={};switch(e.start=moment.utc(e.start),e.end=moment.utc(e.end),e.start.day()){case 1:t.day="M";break;case 2:t.day="T";break;case 3:t.day="W";break;case 4:t.day="R";break;case 5:t.day="F"}var n=e.start.hour(),r="AM";n>12&&(n-=12,r="PM"),n=("0"+n).slice(-2);var a=e.start.minute();a=("0"+a).slice(-2),t.startTime=n+":"+a+" "+r;var n=e.end.hour(),r="AM";n>12&&(n-=12,r="PM"),n=("0"+n).slice(-2);var a=e.end.minute();return a=("0"+a).slice(-2),t.endTime=n+":"+a+" "+r,t};return t}]),winstonApp.factory("addedCourses",["localStorageService",function(e){var t={};return t.data=e.get("addedCourses.data")||{},t.courseAdded=e.get("addedCourses.courseAdded")||{},t}]),winstonApp.factory("courseDataMaker",["courseFactory","$window","currentTerm",function(e,t,n){function r(e,t){this.faculty=e,this.subjects=t}function a(e){var t=!1;if(u.treeCourses.forEach(function(n){n.faculty===e.faculty&&(e.subjects.forEach(function(e){n.subjects.push(e)}),t=!0)}),!t){var n=[];e.subjects.forEach(function(e){n.push(e)}),u.treeCourses.push(new r(e.faculty,n))}}function o(e){e.objects.forEach(function(e){a(e)}),u.flatCourses.length=0,Array.prototype.push.apply(u.flatCourses,s(u.treeCourses)),u.flatSubjects.length=0,Array.prototype.push.apply(u.flatSubjects,c(u.treeCourses))}function s(e){return _.chain(e).map(function(e){return _.map(e.subjects,function(t){return _.map(t.courses,function(n){return n.number=new RegExp("[0-9]+").exec(n.asString).join(),_.extend(_.pick(e,"faculty"),_.pick(t,"subject","subjectTitle"),_.pick(n,"course","asString","courseTitle","number"))})})}).flatten().value()}function c(e){return _.chain(e).map(function(e){return _.map(e.subjects,function(e){return _.values(_.extend(_.pick(e,"subject")))})}).flatten().value()}var u={};return u.treeCourses=[],u.flatCourses=[],u.flatSubjects=[],u.coursesDataPromise=e.getCoursesPage(1,n.termId).success(function(r){pageListing=angular.fromJson(r);var a=pageListing.total_pages;o(pageListing);for(var s=2;a>=s;)e.getCoursesPage(s,n.termId).success(function(e){o(angular.fromJson(e))}).error(function(){t.alert("Server not responding.  All we can say is, try again later.")}),s+=1}).error(function(){t.alert("Server not responding.  All we can say is, try again later.")}),u}]),winstonApp.factory("courseFactory",["$window","$http","$q","localStorageService",function(e,t){var n={};return n.getCoursesPage=function(e,n){return t({method:"GET",url:'https://classtime.herokuapp.com/api/v1/courses-min?q={"filters":[{"name":"institution","op":"equals","val":"ualberta"},{"name":"term","op":"equals","val":"'+n+'"}]}&page='+e})},n}]),winstonApp.factory("currentTerm",["localStorageService",function(e){var t={};return t=e.get("currentTerm")||{name:"Fall 2015",termId:"1530"}}]),winstonApp.factory("detailFactory",["$window","$http","$q",function(e,t){function n(e,t){return e=e.toString(),e.length<t?n("0"+e,t):e}var r={};return r.getDetails=function(e){var r=n(e,6);return t({method:"GET",url:"https://classtime.herokuapp.com/api/v1/courses/"+r})},r}]),winstonApp.directive("facebook",["$http",function(e){return{scope:{shares:"="},transclude:!0,template:'<div class="facebookButton"><div class="pluginButton"><div class="pluginButtonContainer"><div class="pluginButtonImage"><button type="button"><i class="pluginButtonIcon img sp_plugin-button-2x sx_plugin-button-2x_favblue"></i></button></div><span class="pluginButtonLabel">Share</span></div></div></div><div class="facebookCount"><div class="pluginCountButton pluginCountNum"><span ng-transclude></span></div><div class="pluginCountButtonNub"><s></s><i></i></div></div>',link:function(t,n,r){r.$observe("url",function(){r.shares&&r.url&&e.get("https://api.facebook.com/method/links.getStats?urls="+r.url+"&format=json").success(function(e){var n=e[0]?e[0].total_count.toString():0,r="";n.length>6?("0"!=n.slice(-6,-5)&&(r="."+n.slice(-6,-5)),n=n.slice(0,-6),n=n+r+"M"):n.length>3&&("0"!=n.slice(-3,-2)&&(r="."+n.slice(-3,-2)),n=n.slice(0,-3),n=n+r+"k"),t.shares=n}).error(function(){t.shares=0}),n.unbind(),n.bind("click",function(e){FB.ui({method:"share",href:r.url}),e.preventDefault()})})}}}]),winstonApp.filter("courseFilter",["pmkr.filterStabilize","$window",function(e){return e(function(e,t){function n(e){return _.chain(e).map(function(e){return _.map(e.subjects,function(t){return _.map(t.courses,function(n){return _.extend(_.pick(e,"faculty"),_.pick(t,"subject","subjectTitle"),_.pick(n,"course","asString","courseTitle"))})})}).flatten().value()}if(_.isString(t)){var r=n(e),a=new Fuse(r,{keys:["courseTitle"],includeScore:!0}),o=new Fuse(r,{keys:["subjectTitle"],includeScore:!0}),s=new Fuse(r,{keys:["asString"],includeScore:!0}),c=a.search(t),u=o.search(t),i=s.search(t);return console.log(c),console.log(u),console.log(i),console.log("============================================="),[]}})}]),winstonApp.directive("noBubble",function(){return{link:function(e,t){t.bind("click",function(e){e.stopPropagation()})}}}),winstonApp.factory("preferencesValues",function(){var e={};return e.data=[],e}),winstonApp.factory("readyMadeSchedules",["scheduleFactory","addedCourses","$window","$location","addedBusyTime","$modal","$timeout","$route","ngProgressLite","preferencesValues","currentTerm",function(e,t,n,r,a,o,s,c,u,i,d){function l(e){var t=[],n=["#673AB7","#2196F3","#009688","#607D8B","#FF9800","#F44336"],r=0,a=[];return e.objects.forEach(function(e){var o=[];e.sections.forEach(function(e){function a(){o.push({title:e.asString,start:new Date(v,y,g+m,s,i),end:new Date(v,y,g+m,l,d),color:f,description:e.courseDescription})}if(null!==e.startTime&&null!==e.endTime&&null!==e.day){var s,c=e.startTime.match(/(\d+):(\d+)/),u=e.endTime.match(/(\d+):(\d+)/),i=parseInt(c[2]),d=parseInt(u[2]);s=e.startTime.match(/PM/)&&12!=c[1]?parseInt(c[1])+12:parseInt(c[1]);var l;l=e.endTime.match(/PM/)&&12!=u[1]?parseInt(u[1])+12:parseInt(u[1]);var f,p=!1;t.forEach(function(t){t.name===e.course&&(f=t.color,p=!0)}),p||(f=n[r],t.push({name:e.course,color:f}),r+=1);var m,h=new Date,g=h.getDate(),y=h.getMonth(),v=h.getFullYear(),b=h.getDay();e.day.match(/M/)&&(m=1-b,a()),e.day.match(/T/)&&(m=2-b,a()),e.day.match(/W/)&&(m=3-b,a()),e.day.match(/R/)&&(m=4-b,a()),e.day.match(/F/)&&(m=5-b,a())}}),a.push(o)}),a}var f={};return f.readyMadeSchedules=null,f.getSchedulesPromise=function(){return t.data[d.termId]||(t.data[d.termId]=[]),t.data[d.termId]&&0!==t.data[d.termId].length?(a.generateApiFormattedBusyTimes(),u.set(.6),e.getSchedules(t.data[d.termId],a.apiFormattedData,i.data).success(function(e){var t=angular.fromJson(e);if(f.readyMadeSchedules=l(t),0===f.readyMadeSchedules.length){f.readyMadeSchedules=null;{o.open({templateUrl:"noSchedulesModal.html",controller:"noSchedulesModalCtrl"})}}}).error(function(){n.alert("Server not responding..."),r.path("/browse")})["finally"](function(){u.done()})):(f.readyMadeSchedules=null,void u.done())},f}]),winstonApp.factory("scheduleFactory",["$window","$http","$q","currentTerm",function(e,t,n,r){var a={};return a.getSchedules=function(e,n,a){var o=[];e.forEach(function(e){o.push(e.course)});var s={};if(s.institution="ualberta",s.term=r.termId,s.courses=o,"undefined"!=typeof n&&(s["busy-times"]=n),"undefined"!=typeof a){var c={};c["start-early"]=a[0],c["no-marathons"]=-a[1],c["day-classes"]=-a[2],c["current-status"]=!1,c["obey-status"]=!1,s.preferences=c}return t({method:"GET",url:"https://classtime.herokuapp.com/api/v1/generate-schedules?q="+angular.toJson(s)})},a}]),winstonApp.directive("scrollSmooth",["$document","$window",function(e){return{restrict:"A",link:function(t,n){n.bind("click",function(t){t.stopPropagation();var r=n[0].getBoundingClientRect().top,a=500,o=function(e){return 0===e?2:2*Math.pow(2,10*(e/3-1))+1};0>r&&e.scrollToElement(n,0,a,o())})}}}]),winstonApp.directive("staticInclude",["$http","$templateCache","$compile",function(e,t,n){return function(r,a,o){var s=o.staticInclude;e.get(s,{cache:t}).success(function(e){var t=a.html(e).contents();n(t)(r)})}}]);